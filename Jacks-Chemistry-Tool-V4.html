<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chem Studio • Elements, Ions, Trends, Balancing, Naming, Stoich</title>
<style>
  :root{
    --bg:#0f1220; --panel:#171a2b; --ink:#f4f6ff; --muted:#aab3d9; --accent:#7aa2ff; --accent2:#5a7fe6;
    --chip:#22263b; --chip2:#1a1e31; --sel:#2a3a7a;
    --c-alkali:#ef476f; --c-alkaline:#ffd166; --c-transition:#06d6a0; --c-post:#8ecae6;
    --c-metalloid:#f7b267; --c-nonmetal:#cdb4db; --c-halogen:#90be6d; --c-noble:#ffb3c1;
    --c-lanth:#80ed99; --c-actin:#64dfdf; --c-unknown:#adb5bd;
    /* Valence color scale */
    --val1:#ff6b6b; --val2:#ffa94d; --val3:#ffd43b; --val4:#94d82d;
    --val5:#51cf66; --val6:#38d9a9; --val7:#4dabf7; --val8:#b197fc;
    /* Trend gradients */
    --grad-h: linear-gradient(90deg, #2b2d42, #5f67c4, #7aa2ff);
    --grad-v: linear-gradient(180deg, #2b2d42, #5f67c4, #7aa2ff);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:radial-gradient(1200px 900px at 20% -10%, #1a2141 0%, #0f1220 60%) fixed;
    color:var(--ink); font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial
  }
  a{color:var(--accent)}
  .wrap{max-width:1240px;margin:28px auto 64px;padding:0 20px}
  header h1{margin:0 0 6px;font-size:26px}
  header p{margin:0 0 16px;color:var(--muted)}
  /* Tabs */
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 16px}
  .tab{padding:8px 12px;border:1px solid #2a2f50;background:#121631;border-radius:10px;color:var(--ink);cursor:pointer}
  .tab.active{background:linear-gradient(180deg,var(--accent),var(--accent2));color:#0c1026;font-weight:700;border-color:transparent}
  .screen{display:none}
  .screen.active{display:block}
  /* Common UI bits */
  .panel{background:var(--panel);border:1px solid #262b46;border-radius:14px;padding:16px;margin-bottom:14px}
  .muted{color:var(--muted)} .small{font-size:13px}
  .btn{background:linear-gradient(180deg,var(--accent),var(--accent2));color:#0c1026;font-weight:700;border:none;border-radius:10px;padding:9px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid #2a2f50;color:var(--ink)}
  .btn.secondary{background:#222746;color:var(--ink);border:1px solid #2a2f50}
  input[type=text], input[type=number], textarea, select{
    width:100%;padding:9px 10px;border-radius:10px;border:1px solid #2a2f50;background:#10142a;color:var(--ink)
  }
  .grid2{display:grid;grid-template-columns:1.1fr 1fr;gap:16px}
  @media (max-width:1100px){.grid2{grid-template-columns:1fr}}
  .kv{display:grid;grid-template-columns:180px 1fr;gap:6px 16px;margin-top:8px}
  .kv div{padding:4px 0;border-bottom:1px dashed #2b3052}
  .kv .label{color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .pill{display:inline-block;background:var(--chip2);color:var(--muted);border:1px solid #2a2f50;border-radius:8px;padding:2px 8px;font-size:12px;margin-right:6px;margin-top:4px}
  .chip{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #2a2f50;background:#1a1e31}
  .valence-chip{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2a2f50;background:#1a1e31;font-size:12px}
  .sup{vertical-align:super;font-size:.75em}
  .sep{height:1px;background:#262b46;margin:12px 0}
  .results{display:grid;gap:10px}
  .card{background:#121631;border:1px solid #272b4a;border-radius:12px;padding:14px}
  .card h3{margin:0 0 6px;font-size:18px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0 10px}
  .switch{display:inline-flex;border:1px solid #2a2f50;border-radius:10px;overflow:hidden}
  .switch button{padding:6px 10px;background:#1a1e31;border:0;color:var(--muted);cursor:pointer}
  .switch button.active{background:#7aa2ff;color:#0c1026;font-weight:700}
  .val-legend{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
  .val-legend .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;vertical-align:middle}

  /* Periodic table */
  .ptable{margin-top:10px;display:grid;grid-template-columns:repeat(18,minmax(36px,1fr));gap:6px}
  .pt-el{position:relative;background:#141a34;border:1px solid #2a2f50;border-radius:10px;padding:6px 6px 8px;min-height:52px;cursor:pointer;transition:transform .06s ease,border-color .06s ease}
  .pt-el:hover{transform:translateY(-1px);border-color:var(--accent)}
  .pt-el.selected{outline:2px solid var(--accent);background:#17214a}
  .pt-sym{font-size:14px;font-weight:700}
  .pt-num{position:absolute;top:4px;right:6px;font-size:11px;color:var(--muted)}
  .pt-name{font-size:10px;color:var(--muted);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  /* Category tints */
  .cat-alkali{background:color-mix(in srgb, var(--c-alkali) 22%, #141a34)}
  .cat-alkaline{background:color-mix(in srgb, var(--c-alkaline) 22%, #141a34)}
  .cat-transition{background:color-mix(in srgb, var(--c-transition) 22%, #141a34)}
  .cat-post{background:color-mix(in srgb, var(--c-post) 22%, #141a34)}
  .cat-metalloid{background:color-mix(in srgb, var(--c-metalloid) 22%, #141a34)}
  .cat-nonmetal{background:color-mix(in srgb, var(--c-nonmetal) 22%, #141a34)}
  .cat-halogen{background:color-mix(in srgb, var(--c-halogen) 22%, #141a34)}
  .cat-noble{background:color-mix(in srgb, var(--c-noble) 22%, #141a34)}
  .cat-lanthanoid{background:color-mix(in srgb, var(--c-lanth) 22%, #141a34)}
  .cat-actinoid{background:color-mix(in srgb, var(--c-actin) 22%, #141a34)}
  .cat-unknown{background:color-mix(in srgb, var(--c-unknown) 22%, #141a34)}

  /* Tables in tools */
  table{width:100%;border-collapse:collapse;border:1px solid #2a2f50}
  th,td{padding:8px;border-bottom:1px solid #2a2f50;text-align:left}
  thead th{background:#141a34}

  @media print{
    body{background:#fff;color:#000}
    .tabs, .toolbar, .val-legend, .row .btn, .switch, .searchbar, .tips{display:none !important}
    .panel, .card{border:none;background:#fff}
    .wrap{margin:0}
    a{color:#000}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Chem Studio</h1>
    <p class="muted small">All-in-one study buddy: elements, ions, printable sheets, periodic trends, balancing equations, naming, and stoichiometry.</p>
  </header>

  <!-- TABS -->
  <div class="tabs" role="tablist" aria-label="Chem Studio Sections">
    <button class="tab active" data-target="screen-core">Elements & Ions</button>
    <button class="tab" data-target="screen-sheets">Printable Sheets</button>
    <button class="tab" data-target="screen-trends">Periodic Trends</button>
    <button class="tab" data-target="screen-balance">Balancing Trainer</button>
    <button class="tab" data-target="screen-naming">Nomenclature Coach</button>
    <button class="tab" data-target="screen-stoich">Stoichiometry Lab</button>
  </div>

  <!-- SCREEN 1: Core search + interactive table -->
  <section id="screen-core" class="screen active">
    <div class="panel">
      <div class="row">
        <div style="flex:1 1 420px">
          <div class="row">
            <input id="q" type="text" placeholder="Try Fe, iron, 26, sulfate, SO4^2-, NH4+">
            <button class="btn" id="go">Search</button>
            <button class="btn secondary" id="clear">Clear</button>
          </div>
          <div class="toolbar">
            <div class="switch" role="tablist" aria-label="Shell view">
              <button id="viewFull" class="active" aria-selected="true">Full shells</button>
              <button id="viewLewis" aria-selected="false">Lewis (valence)</button>
            </div>
            <span class="muted small">Switch changes how the element diagram renders.</span>
          </div>
          <div class="val-legend small muted">
            <span><span class="dot" style="background:var(--val1)"></span>1</span>
            <span><span class="dot" style="background:var(--val2)"></span>2</span>
            <span><span class="dot" style="background:var(--val3)"></span>3</span>
            <span><span class="dot" style="background:var(--val4)"></span>4</span>
            <span><span class="dot" style="background:var(--val5)"></span>5</span>
            <span><span class="dot" style="background:var(--val6)"></span>6</span>
            <span><span class="dot" style="background:var(--val7)"></span>7</span>
            <span><span class="dot" style="background:var(--val8)"></span>8</span>
          </div>
        </div>
        <div class="row" style="justify-content:flex-end;align-items:center">
          <button class="btn ghost" id="printBtn">Print results</button>
          <button class="btn ghost" id="copyBtn">Copy results</button>
          <button class="btn ghost" id="downloadBtn">Download .txt</button>
          <button class="btn ghost" id="shareBtn">Share…</button>
        </div>
      </div>
    </div>

    <div class="grid2">
      <section class="panel">
        <h2 style="margin:0 0 6px">Results</h2>
        <div id="results" class="results"></div>
        <div id="empty" class="muted small">No results yet. Examples: <span class="mono">Na</span>, <span class="mono">oxygen</span>, <span class="mono">17</span>, <span class="mono">acetate</span>, <span class="mono">CO3^2-</span>.</div>
      </section>
      <aside class="panel">
        <h2 style="margin:0 0 6px">Interactive Periodic Table</h2>
        <div id="ptable" class="ptable"></div>
        <p class="small tips muted" style="margin-top:8px">
          Shift click to append multiple elements. Cells are tinted by category.  
          Lewis view colors dots by valence count and shows a colored valence chip.
        </p>
      </aside>
    </div>
  </section>

  <!-- SCREEN 2: Printable sheets -->
  <section id="screen-sheets" class="screen">
    <div class="panel">
      <h2 style="margin:0 0 8px">Printable Study Sheets</h2>
      <div class="row">
        <button class="btn" onclick="renderSheet('ions')">Top 50 Polyatomic Ions</button>
        <button class="btn" onclick="renderSheet('oxidation')">Common Oxidation States</button>
        <button class="btn" onclick="renderSheet('prefixes')">Covalent Prefixes</button>
        <button class="btn" onclick="renderSheet('acids')">Oxoacid Names</button>
        <button class="btn" onclick="renderSheet('solubility')">Solubility Rules</button>
        <button class="btn ghost" onclick="window.print()">Print</button>
      </div>
    </div>
    <div class="panel">
      <div id="sheetArea"></div>
    </div>
  </section>

  <!-- SCREEN 3: Periodic trends -->
  <section id="screen-trends" class="screen">
    <div class="panel">
      <h2 style="margin:0 0 8px">Periodic Trends Overlay</h2>
      <div class="row">
        <select id="trendSelect" style="max-width:280px">
          <option value="none">None</option>
          <option value="electronegativity">Electronegativity (Pauling, partial)</option>
          <option value="atomic_radius">Atomic radius (pm, partial)</option>
          <option value="ionization">1st Ionization Energy (kJ/mol, partial)</option>
          <option value="demo_horizontal">Demo gradient across a period</option>
          <option value="demo_vertical">Demo gradient down a group</option>
        </select>
        <button class="btn" onclick="applyTrend()">Apply</button>
        <button class="btn secondary" onclick="clearTrend()">Clear</button>
      </div>
      <p class="muted small">Overlays color cells. Hover a cell for the exact value when available.</p>
    </div>
    <div class="panel">
      <div id="trendTable" class="ptable"></div>
    </div>
  </section>

  <!-- SCREEN 4: Balancing trainer -->
  <section id="screen-balance" class="screen">
    <div class="panel">
      <h2 style="margin:0 0 8px">Balancing Equations Trainer</h2>
      <div class="row">
        <input id="eqInput" type="text" placeholder='Examples: Fe + O2 -> Fe2O3   |   C2H6 + O2 -> CO2 + H2O'>
        <button class="btn" onclick="balanceUI()">Balance</button>
        <button class="btn secondary" onclick="document.getElementById('eqSteps').innerHTML='';document.getElementById('eqOutput').textContent=''">Clear</button>
      </div>
      <div id="eqOutput" class="mono" style="margin-top:8px"></div>
      <div id="eqSteps" class="small muted" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- SCREEN 5: Naming -->
  <section id="screen-naming" class="screen">
    <div class="panel">
      <h2 style="margin:0 0 8px">Nomenclature Coach</h2>
      <div class="row">
        <input id="nameInput" type="text" placeholder="Name or formula: sodium sulfate, FeCl3, H2SO4, dinitrogen pentoxide">
        <button class="btn" onclick="nameCoach()">Convert</button>
        <button class="btn secondary" onclick="document.getElementById('nameOut').innerHTML=''">Clear</button>
      </div>
      <div id="nameOut" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- SCREEN 6: Stoichiometry -->
  <section id="screen-stoich" class="screen">
    <div class="panel">
      <h2 style="margin:0 0 8px">Stoichiometry Mini-Lab</h2>
      <div class="grid2">
        <div>
          <h3 style="margin:4px 0">Molar Mass + Percent Composition</h3>
          <div class="row">
            <input id="mmFormula" type="text" placeholder="Formula: C6H12O6, Ca3(PO4)2, NH4NO3">
            <button class="btn" onclick="calcMolarMass()">Calculate</button>
          </div>
          <div id="mmOut" style="margin-top:8px"></div>
        </div>
        <div>
          <h3 style="margin:4px 0">Grams ↔ Moles</h3>
          <div class="row">
            <input id="gmFormula" type="text" placeholder="Formula for molar mass">
            <input id="gmValue" type="number" placeholder="Value">
            <select id="gmMode" style="max-width:180px">
              <option value="g2mol">grams → moles</option>
              <option value="mol2g">moles → grams</option>
            </select>
            <button class="btn" onclick="gramsMoles()">Convert</button>
          </div>
          <div id="gmOut" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
  </section>

</div>

<script>
/* ===========================
   DATA: Elements (positions, masses, categories)
=========================== */
const ELEMENTS = [
  {n:1,s:"H",name:"Hydrogen",mass:1.008,cat:"nonmetal",x:1,y:1},
  {n:2,s:"He",name:"Helium",mass:4.0026,cat:"noble gas",x:18,y:1},
  {n:3,s:"Li",name:"Lithium",mass:6.94,cat:"alkali metal",x:1,y:2},
  {n:4,s:"Be",name:"Beryllium",mass:9.0122,cat:"alkaline earth metal",x:2,y:2},
  {n:5,s:"B",name:"Boron",mass:10.81,cat:"metalloid",x:13,y:2},
  {n:6,s:"C",name:"Carbon",mass:12.011,cat:"nonmetal",x:14,y:2},
  {n:7,s:"N",name:"Nitrogen",mass:14.007,cat:"nonmetal",x:15,y:2},
  {n:8,s:"O",name:"Oxygen",mass:15.999,cat:"nonmetal",x:16,y:2},
  {n:9,s:"F",name:"Fluorine",mass:18.998,cat:"halogen",x:17,y:2},
  {n:10,s:"Ne",name:"Neon",mass:20.180,cat:"noble gas",x:18,y:2},
  {n:11,s:"Na",name:"Sodium",mass:22.990,cat:"alkali metal",x:1,y:3},
  {n:12,s:"Mg",name:"Magnesium",mass:24.305,cat:"alkaline earth metal",x:2,y:3},
  {n:13,s:"Al",name:"Aluminum",mass:26.982,cat:"post-transition metal",x:13,y:3},
  {n:14,s:"Si",name:"Silicon",mass:28.085,cat:"metalloid",x:14,y:3},
  {n:15,s:"P",name:"Phosphorus",mass:30.974,cat:"nonmetal",x:15,y:3},
  {n:16,s:"S",name:"Sulfur",mass:32.06,cat:"nonmetal",x:16,y:3},
  {n:17,s:"Cl",name:"Chlorine",mass:35.45,cat:"halogen",x:17,y:3},
  {n:18,s:"Ar",name:"Argon",mass:39.948,cat:"noble gas",x:18,y:3},
  {n:19,s:"K",name:"Potassium",mass:39.098,cat:"alkali metal",x:1,y:4},
  {n:20,s:"Ca",name:"Calcium",mass:40.078,cat:"alkaline earth metal",x:2,y:4},
  {n:21,s:"Sc",name:"Scandium",mass:44.956,cat:"transition metal",x:3,y:4},
  {n:22,s:"Ti",name:"Titanium",mass:47.867,cat:"transition metal",x:4,y:4},
  {n:23,s:"V",name:"Vanadium",mass:50.942,cat:"transition metal",x:5,y:4},
  {n:24,s:"Cr",name:"Chromium",mass:51.996,cat:"transition metal",x:6,y:4},
  {n:25,s:"Mn",name:"Manganese",mass:54.938,cat:"transition metal",x:7,y:4},
  {n:26,s:"Fe",name:"Iron",mass:55.845,cat:"transition metal",x:8,y:4},
  {n:27,s:"Co",name:"Cobalt",mass:58.933,cat:"transition metal",x:9,y:4},
  {n:28,s:"Ni",name:"Nickel",mass:58.693,cat:"transition metal",x:10,y:4},
  {n:29,s:"Cu",name:"Copper",mass:63.546,cat:"transition metal",x:11,y:4},
  {n:30,s:"Zn",name:"Zinc",mass:65.38,cat:"transition metal",x:12,y:4},
  {n:31,s:"Ga",name:"Gallium",mass:69.723,cat:"post-transition metal",x:13,y:4},
  {n:32,s:"Ge",name:"Germanium",mass:72.630,cat:"metalloid",x:14,y:4},
  {n:33,s:"As",name:"Arsenic",mass:74.922,cat:"metalloid",x:15,y:4},
  {n:34,s:"Se",name:"Selenium",mass:78.971,cat:"nonmetal",x:16,y:4},
  {n:35,s:"Br",name:"Bromine",mass:79.904,cat:"halogen",x:17,y:4},
  {n:36,s:"Kr",name:"Krypton",mass:83.798,cat:"noble gas",x:18,y:4},
  {n:37,s:"Rb",name:"Rubidium",mass:85.468,cat:"alkali metal",x:1,y:5},
  {n:38,s:"Sr",name:"Strontium",mass:87.62,cat:"alkaline earth metal",x:2,y:5},
  {n:39,s:"Y",name:"Yttrium",mass:88.906,cat:"transition metal",x:3,y:5},
  {n:40,s:"Zr",name:"Zirconium",mass:91.224,cat:"transition metal",x:4,y:5},
  {n:41,s:"Nb",name:"Niobium",mass:92.906,cat:"transition metal",x:5,y:5},
  {n:42,s:"Mo",name:"Molybdenum",mass:95.95,cat:"transition metal",x:6,y:5},
  {n:43,s:"Tc",name:"Technetium",mass:98,cat:"transition metal",x:7,y:5},
  {n:44,s:"Ru",name:"Ruthenium",mass:101.07,cat:"transition metal",x:8,y:5},
  {n:45,s:"Rh",name:"Rhodium",mass:102.91,cat:"transition metal",x:9,y:5},
  {n:46,s:"Pd",name:"Palladium",mass:106.42,cat:"transition metal",x:10,y:5},
  {n:47,s:"Ag",name:"Silver",mass:107.868,cat:"transition metal",x:11,y:5},
  {n:48,s:"Cd",name:"Cadmium",mass:112.414,cat:"transition metal",x:12,y:5},
  {n:49,s:"In",name:"Indium",mass:114.818,cat:"post-transition metal",x:13,y:5},
  {n:50,s:"Sn",name:"Tin",mass:118.710,cat:"post-transition metal",x:14,y:5},
  {n:51,s:"Sb",name:"Antimony",mass:121.760,cat:"metalloid",x:15,y:5},
  {n:52,s:"Te",name:"Tellurium",mass:127.60,cat:"metalloid",x:16,y:5},
  {n:53,s:"I",name:"Iodine",mass:126.904,cat:"halogen",x:17,y:5},
  {n:54,s:"Xe",name:"Xenon",mass:131.293,cat:"noble gas",x:18,y:5},
  {n:55,s:"Cs",name:"Cesium",mass:132.905,cat:"alkali metal",x:1,y:6},
  {n:56,s:"Ba",name:"Barium",mass:137.327,cat:"alkaline earth metal",x:2,y:6},
  {n:57,s:"La",name:"Lanthanum",mass:138.905,cat:"lanthanoid",x:3,y:6},
  {n:58,s:"Ce",name:"Cerium",mass:140.116,cat:"lanthanoid",x:4,y:8},
  {n:59,s:"Pr",name:"Praseodymium",mass:140.908,cat:"lanthanoid",x:5,y:8},
  {n:60,s:"Nd",name:"Neodymium",mass:144.242,cat:"lanthanoid",x:6,y:8},
  {n:61,s:"Pm",name:"Promethium",mass:145,cat:"lanthanoid",x:7,y:8},
  {n:62,s:"Sm",name:"Samarium",mass:150.36,cat:"lanthanoid",x:8,y:8},
  {n:63,s:"Eu",name:"Europium",mass:151.964,cat:"lanthanoid",x:9,y:8},
  {n:64,s:"Gd",name:"Gadolinium",mass:157.25,cat:"lanthanoid",x:10,y:8},
  {n:65,s:"Tb",name:"Terbium",mass:158.925,cat:"lanthanoid",x:11,y:8},
  {n:66,s:"Dy",name:"Dysprosium",mass:162.500,cat:"lanthanoid",x:12,y:8},
  {n:67,s:"Ho",name:"Holmium",mass:164.930,cat:"lanthanoid",x:13,y:8},
  {n:68,s:"Er",name:"Erbium",mass:167.259,cat:"lanthanoid",x:14,y:8},
  {n:69,s:"Tm",name:"Thulium",mass:168.934,cat:"lanthanoid",x:15,y:8},
  {n:70,s:"Yb",name:"Ytterbium",mass:173.045,cat:"lanthanoid",x:16,y:8},
  {n:71,s:"Lu",name:"Lutetium",mass:174.967,cat:"lanthanoid",x:4,y:6},
  {n:72,s:"Hf",name:"Hafnium",mass:178.49,cat:"transition metal",x:5,y:6},
  {n:73,s:"Ta",name:"Tantalum",mass:180.948,cat:"transition metal",x:6,y:6},
  {n:74,s:"W",name:"Tungsten",mass:183.84,cat:"transition metal",x:7,y:6},
  {n:75,s:"Re",name:"Rhenium",mass:186.207,cat:"transition metal",x:8,y:6},
  {n:76,s:"Os",name:"Osmium",mass:190.23,cat:"transition metal",x:9,y:6},
  {n:77,s:"Ir",name:"Iridium",mass:192.217,cat:"transition metal",x:10,y:6},
  {n:78,s:"Pt",name:"Platinum",mass:195.084,cat:"transition metal",x:11,y:6},
  {n:79,s:"Au",name:"Gold",mass:196.967,cat:"transition metal",x:12,y:6},
  {n:80,s:"Hg",name:"Mercury",mass:200.592,cat:"transition metal",x:13,y:6},
  {n:81,s:"Tl",name:"Thallium",mass:204.38,cat:"post-transition metal",x:14,y:6},
  {n:82,s:"Pb",name:"Lead",mass:207.2,cat:"post-transition metal",x:15,y:6},
  {n:83,s:"Bi",name:"Bismuth",mass:208.980,cat:"post-transition metal",x:16,y:6},
  {n:84,s:"Po",name:"Polonium",mass:209,cat:"post-transition metal",x:17,y:6},
  {n:85,s:"At",name:"Astatine",mass:210,cat:"halogen",x:18,y:6},
  {n:86,s:"Rn",name:"Radon",mass:222,cat:"noble gas",x:18,y:6},
  {n:87,s:"Fr",name:"Francium",mass:223,cat:"alkali metal",x:1,y:7},
  {n:88,s:"Ra",name:"Radium",mass:226,cat:"alkaline earth metal",x:2,y:7},
  {n:89,s:"Ac",name:"Actinium",mass:227,cat:"actinoid",x:3,y:7},
  {n:90,s:"Th",name:"Thorium",mass:232.038,cat:"actinoid",x:4,y:9},
  {n:91,s:"Pa",name:"Protactinium",mass:231.036,cat:"actinoid",x:5,y:9},
  {n:92,s:"U",name:"Uranium",mass:238.029,cat:"actinoid",x:6,y:9},
  {n:93,s:"Np",name:"Neptunium",mass:237,cat:"actinoid",x:7,y:9},
  {n:94,s:"Pu",name:"Plutonium",mass:244,cat:"actinoid",x:8,y:9},
  {n:95,s:"Am",name:"Americium",mass:243,cat:"actinoid",x:9,y:9},
  {n:96,s:"Cm",name:"Curium",mass:247,cat:"actinoid",x:10,y:9},
  {n:97,s:"Bk",name:"Berkelium",mass:247,cat:"actinoid",x:11,y:9},
  {n:98,s:"Cf",name:"Californium",mass:251,cat:"actinoid",x:12,y:9},
  {n:99,s:"Es",name:"Einsteinium",mass:252,cat:"actinoid",x:13,y:9},
  {n:100,s:"Fm",name:"Fermium",mass:257,cat:"actinoid",x:14,y:9},
  {n:101,s:"Md",name:"Mendelevium",mass:258,cat:"actinoid",x:15,y:9},
  {n:102,s:"No",name:"Nobelium",mass:259,cat:"actinoid",x:16,y:9},
  {n:103,s:"Lr",name:"Lawrencium",mass:262,cat:"actinoid",x:4,y:7},
  {n:104,s:"Rf",name:"Rutherfordium",mass:267,cat:"transition metal",x:5,y:7},
  {n:105,s:"Db",name:"Dubnium",mass:270,cat:"transition metal",x:6,y:7},
  {n:106,s:"Sg",name:"Seaborgium",mass:271,cat:"transition metal",x:7,y:7},
  {n:107,s:"Bh",name:"Bohrium",mass:270,cat:"transition metal",x:8,y:7},
  {n:108,s:"Hs",name:"Hassium",mass:277,cat:"transition metal",x:9,y:7},
  {n:109,s:"Mt",name:"Meitnerium",mass:278,cat:"unknown",x:10,y:7},
  {n:110,s:"Ds",name:"Darmstadtium",mass:281,cat:"unknown",x:11,y:7},
  {n:111,s:"Rg",name:"Roentgenium",mass:282,cat:"unknown",x:12,y:7},
  {n:112,s:"Cn",name:"Copernicium",mass:285,cat:"transition metal",x:13,y:7},
  {n:113,s:"Nh",name:"Nihonium",mass:286,cat:"post-transition metal",x:14,y:7},
  {n:114,s:"Fl",name:"Flerovium",mass:289,cat:"post-transition metal",x:15,y:7},
  {n:115,s:"Mc",name:"Moscovium",mass:289,cat:"post-transition metal",x:16,y:7},
  {n:116,s:"Lv",name:"Livermorium",mass:293,cat:"post-transition metal",x:17,y:7},
  {n:117,s:"Ts",name:"Tennessine",mass:294,cat:"halogen",x:18,y:7},
  {n:118,s:"Og",name:"Oganesson",mass:294,cat:"noble gas",x:18,y:7}
];
const ELEMENT_BY_SYMBOL = Object.fromEntries(ELEMENTS.map(e => [e.s.toLowerCase(), e]));
const ELEMENT_BY_NAME   = Object.fromEntries(ELEMENTS.map(e => [e.name.toLowerCase(), e]));
const ELEMENT_BY_ATOMIC = Object.fromEntries(ELEMENTS.map(e => [String(e.n), e]));

/* ===========================
   DATA: ~50 Common polyatomic ions
=========================== */
const IONS = [
  ["ammonium","NH4",+1,["ammonium ion"]],
  ["hydronium","H3O",+1,["oxonium"]],
  ["acetate","C2H3O2",-1,["ethanoate","CH3COO"]],
  ["formate","HCOO",-1,["methanoate"]],
  ["propionate","C3H5O2",-1,["propanoate"]],
  ["benzoate","C7H5O2",-1,["C6H5COO"]],
  ["cyanide","CN",-1,[]],
  ["thiocyanate","SCN",-1,[]],
  ["cyanate","OCN",-1,[]],
  ["isocyanate","NCO",-1,[]],
  ["hydroxide","OH",-1,[]],
  ["peroxide","O2",-2,[]],
  ["superoxide","O2",-1,[]],
  ["nitrate","NO3",-1,[]],
  ["nitrite","NO2",-1,[]],
  ["sulfate","SO4",-2,[]],
  ["sulfite","SO3",-2,[]],
  ["bisulfate","HSO4",-1,["hydrogen sulfate"]],
  ["bisulfite","HSO3",-1,["hydrogen sulfite"]],
  ["thiosulfate","S2O3",-2,[]],
  ["carbonate","CO3",-2,[]],
  ["bicarbonate","HCO3",-1,["hydrogen carbonate"]],
  ["phosphate","PO4",-3,[]],
  ["hydrogen phosphate","HPO4",-2,[]],
  ["dihydrogen phosphate","H2PO4",-1,[]],
  ["phosphite","PO3",-3,[]],
  ["arsenate","AsO4",-3,[]],
  ["hydrogen arsenate","HAsO4",-2,[]],
  ["dihydrogen arsenate","H2AsO4",-1,[]],
  ["borate","BO3",-3,[]],
  ["silicate","SiO3",-2,[]],
  ["chromate","CrO4",-2,[]],
  ["dichromate","Cr2O7",-2,[]],
  ["permanganate","MnO4",-1,[]],
  ["hypochlorite","ClO",-1,[]],
  ["chlorite","ClO2",-1,[]],
  ["chlorate","ClO3",-1,[]],
  ["perchlorate","ClO4",-1,[]],
  ["hypobromite","BrO",-1,[]],
  ["bromite","BrO2",-1,[]],
  ["bromate","BrO3",-1,[]],
  ["perbromate","BrO4",-1,[]],
  ["hypoiodite","IO",-1,[]],
  ["iodite","IO2",-1,[]],
  ["iodate","IO3",-1,[]],
  ["periodate","IO4",-1,[]],
  ["oxalate","C2O4",-2,[]],
  ["tartrate","C4H4O6",-2,[]],
  ["citrate","C6H5O7",-3,[]],
  ["acetylide","C2",-2,[]],
  ["azide","N3",-1,[]],
  ["amide","NH2",-1,[]],
  ["peroxydisulfate","S2O8",-2,["persulfate"]],
  ["pyrophosphate","P2O7",-4,[]],
  ["selenate","SeO4",-2,[]],
  ["selenite","SeO3",-2,[]],
  ["tellurate","TeO4",-2,[]]
].map(([name,formula,charge,aliases])=>({name,formula,charge,aliases}));
const ION_BY_NAME = Object.fromEntries(IONS.flatMap(i => {
  const arr = [[i.name.toLowerCase(), i]]; i.aliases.forEach(a => arr.push([a.toLowerCase(), i])); return arr;
}));

/* ===========================
   DATA: Common oxidation states (teaching set)
=========================== */
const OX = {1:[+1,-1],2:[0],3:[+1],4:[+2],5:[+3],6:[+4,-4],7:[-3,+5,+3],8:[-2],9:[-1],10:[0],
11:[+1],12:[+2],13:[+3,+1],14:[+4,+2,-4],15:[-3,+3,+5],16:[-2,+4,+6],17:[-1,+1,+3,+5,+7],18:[0],
19:[+1],20:[+2],21:[+3],22:[+4,+3],23:[+5,+4,+3,+2],24:[+6,+3,+2],25:[+2,+4,+7,+6,+3],26:[+2,+3],27:[+2,+3],28:[+2,+3],29:[+2,+1],30:[+2],
31:[+3],32:[+4,+2],33:[-3,+3,+5],34:[-2,+4,+6],35:[-1,+1,+5],36:[0],
37:[+1],38:[+2],39:[+3],40:[+4],41:[+5,+3],42:[+6,+4],43:[+7,+6,+4],44:[+3,+4,+8],45:[+3,+1,+4],46:[+2,+4],47:[+1],48:[+2],
49:[+3],50:[+4,+2],51:[+3,+5,-3],52:[-2,+4,+6],53:[-1,+1,+5,+7],54:[0,+2,+4,+6,+8],
55:[+1],56:[+2],57:[+3],58:[+3,+4],59:[+3],60:[+3],61:[+3],62:[+3,+2],63:[+3,+2],64:[+3],65:[+3],66:[+3],67:[+3],68:[+3],69:[+3],70:[+3,+2],71:[+3],
72:[+4],73:[+5],74:[+6],75:[+7,+6,+4],76:[+8,+6,+4],77:[+3,+4],78:[+2,+4],79:[+3,+1],80:[+2,+1],81:[+3,+1],82:[+2,+4],83:[+3,+5],84:[+2,+4],85:[-1,+1,+5],86:[0],
87:[+1],88:[+2],89:[+3],90:[+4],91:[+5],92:[+6,+4],93:[+5,+4],94:[+6,+4,+3],95:[+3],96:[+3],97:[+3],98:[+3],99:[+3],100:[+3],101:[+3],102:[+2,+3],
103:[+3],104:[+4],105:[+5],106:[+6],107:[+7],108:[+8],109:[+1,+3],110:[+2,+4],111:[+3,+1],112:[+2],113:[+1,+3],114:[+2,+4],115:[+1,+3],116:[+2,+4],117:[-1,+1,+5],118:[0]};

/* ===========================
   Electron configuration, shells, Lewis dots
=========================== */
const SUBSHELLS=[["1s",2],["2s",2],["2p",6],["3s",2],["3p",6],["4s",2],["3d",10],["4p",6],["5s",2],["4d",10],["5p",6],["6s",2],["4f",14],["5d",10],["6p",6],["7s",2],["5f",14],["6d",10],["7p",6]];
const NOBLES=[{n:2,l:"[He]"}, {n:10,l:"[Ne]"}, {n:18,l:"[Ar]"}, {n:36,l:"[Kr]"}, {n:54,l:"[Xe]"}, {n:86,l:"[Rn]"}];

function electronConfig(Z){
  let r=Z, parts=[];
  for(const [sub,cap] of SUBSHELLS){ if(r<=0) break; const f=Math.min(cap,r); parts.push(`${sub}${f}`); r-=f; }
  let base=0,label=""; for(let i=NOBLES.length-1;i>=0;i--){ if(Z>=NOBLES[i].n){ base=NOBLES[i].n; label=NOBLES[i].l; break; } }
  let left = Z - base, shortParts=[];
  for(const [sub,cap] of SUBSHELLS){ if(left<=0) break; const take=Math.min(cap,left); shortParts.push(`${sub}${take}`); left-=take; }
  const shells={}; parts.forEach(p=>{ const n=parseInt(p[0],10); const e=parseInt(p.slice(2),10); shells[n]=(shells[n]||0)+e; });
  return { full:parts.join(" "), short:label?`${label} ${shortParts.join(" ")}`.trim():parts.join(" "), shells };
}
function valenceCountFromShells(shells){
  const ns=Object.keys(shells).map(n=>+n); const nMax = ns.length? Math.max(...ns) : 0;
  const v = shells[nMax] || 0;
  return Math.max(0, Math.min(8, v));
}
function valenceColor(n){
  const map = {1:"var(--val1)",2:"var(--val2)",3:"var(--val3)",4:"var(--val4)",5:"var(--val5)",6:"var(--val6)",7:"var(--val7)",8:"var(--val8)"};
  return map[n] || "var(--val8)";
}
let SHELL_MODE = "full"; // "full" | "lewis"
function renderShellSVG(shells){
  const entries = Object.entries(shells).map(([n,e])=>({n:+n,e})).sort((a,b)=>a.n-b.n);
  const size=180,cx=90,cy=90;
  const radii={1:18,2:32,3:46,4:60,5:74,6:88,7:102};
  const circles = entries.map(s => `<circle cx="${cx}" cy="${cy}" r="${(radii[s.n]||12*s.n+6)}" fill="none" stroke="#2a2f50" stroke-width="1"/>`).join("");

  if (SHELL_MODE === "full") {
    const dots = entries.map(s=>{
      const r=(radii[s.n]||12*s.n+6)-3, k=Math.max(1,s.e); const pts=[];
      for(let i=0;i<s.e;i++){ const ang=(2*Math.PI*i)/k - Math.PI/2; const ex=cx+r*Math.cos(ang); const ey=cy+r*Math.sin(ang);
        pts.push(`<circle cx="${ex.toFixed(1)}" cy="${ey.toFixed(1)}" r="3.2" fill="#7aa2ff"/>`); }
      return pts.join("");
    }).join("");
    return `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" role="img" aria-label="Electron shells">
      ${circles}
      ${dots}
      <circle cx="${cx}" cy="${cy}" r="6" fill="#7aa2ff"/>
    </svg>`;
  }

  // Lewis view: only outer shell, up to 8 colored dots
  const valence = valenceCountFromShells(shells);
  const nDots = Math.min(8, valence);
  const r = 40; const fill = valenceColor(valence);
  const positions = [ -90, 0, 90, 180, -45, 45, 135, -135 ].slice(0, nDots);
  const dots = positions.map(a=>{
    const rad = a*Math.PI/180, ex = 90 + r*Math.cos(rad), ey = 90 + r*Math.sin(rad);
    return `<circle cx="${ex.toFixed(1)}" cy="${ey.toFixed(1)}" r="4.2" fill="${fill}"/>`;
  }).join("");
  return `<svg width="180" height="180" viewBox="0 0 180 180" role="img" aria-label="Lewis valence">
    <circle cx="90" cy="90" r="${r}" fill="none" stroke="#2a2f50" stroke-width="1"/>
    ${dots}
    <circle cx="90" cy="90" r="6" fill="${fill}"/>
    <text x="140" y="40" font-size="14" fill="${fill}" font-family="ui-monospace,monospace">valence = ${valence}</text>
  </svg>`;
}

/* ===========================
   Formula parsing + molar mass
=========================== */
function normalizeChargeText(ch){ ch=ch.replace(/\s/g,""); const pp=(ch.match(/\+/g)||[]).length, mm=(ch.match(/-/g)||[]).length, num=ch.match(/(\d+)/); if(num){const n=parseInt(num[1],10); if(ch.includes("+"))return +n; if(ch.includes("-"))return -n;} if(pp&&!mm)return +pp; if(mm&&!pp)return -mm; return 0; }
function parseFormula(input){
  let raw=String(input).trim(), charge=0;
  const caret=raw.match(/\^([0-9]+)?([+-])/);
  if(caret){ charge=(caret[2]==="+"?1:-1)*(caret[1]?parseInt(caret[1],10):1); raw=raw.replace(/\^[0-9]*[+-]/,""); }
  else { const trail=raw.match(/([+\-0-9\s]+)$/); if(trail && /[+\-]/.test(trail[1])){ charge=normalizeChargeText(trail[1]); raw=raw.slice(0,raw.length-trail[1].length).trim(); } }
  raw=raw.replace(/\u2212/g,"-");
  let i=0; function parseGroup(){ const counts={}; function add(el,n){counts[el]=(counts[el]||0)+n;}
    while(i<raw.length){ const ch=raw[i];
      if(ch==="("||ch==="["){ i++; const inner=parseGroup(); let m=""; while(/[0-9]/.test(raw[i])) m+=raw[i++]; const mult=m?parseInt(m,10):1; for(const [el,c] of Object.entries(inner)) add(el,c*mult); continue; }
      if(ch===")"||ch==="]"){ i++; break; }
      if(/[A-Z]/.test(ch)){ let sym=ch;i++; if(/[a-z]/.test(raw[i])){sym+=raw[i];i++;} let num=""; while(/[0-9]/.test(raw[i])) num+=raw[i++]; add(sym,num?parseInt(num,10):1); continue; }
      if(ch==="·"||ch==="."){ i++; continue; }
      if(/\s/.test(ch)){ i++; continue; }
      i++;
    } return counts;
  }
  return { stoich:parseGroup(), charge, text:raw };
}
function molarMass(stoich){ let t=0; for(const [sym,cnt] of Object.entries(stoich)){ const el=ELEMENT_BY_SYMBOL[sym.toLowerCase()]; if(!el) return null; t+=el.mass*cnt; } return t; }
function chargeSup(q){ if(!q)return ""; const m=Math.abs(q); return `<span class="sup">${m===1?"":m}${q>0?"+":"−"}</span>`; }
function compositionString(stoich){ return Object.entries(stoich).map(([k,v])=>`${k}${v===1?"":v}`).join(""); }

/* ===========================
   Core search UI renderers
=========================== */
function categoryClass(cat){
  const k=cat.toLowerCase();
  if (k.includes("alkali metal") && !k.includes("alkaline")) return "cat-alkali";
  if (k.includes("alkaline earth")) return "cat-alkaline";
  if (k.includes("transition")) return "cat-transition";
  if (k.includes("post-transition")) return "cat-post";
  if (k.includes("metalloid")) return "cat-metalloid";
  if (k==="nonmetal") return "cat-nonmetal";
  if (k.includes("halogen")) return "cat-halogen";
  if (k.includes("noble gas")) return "cat-noble";
  if (k.includes("lanthanoid")) return "cat-lanthanoid";
  if (k.includes("actinoid")) return "cat-actinoid";
  return "cat-unknown";
}

function renderElement(el, hint){
  const cfg = electronConfig(el.n);
  const ox = OX[el.n] || [];
  const shellList = Object.entries(cfg.shells).sort((a,b)=>a[0]-b[0]).map(([n,c])=>`${n}:${c}`).join("  ");
  const svg = renderShellSVG(cfg.shells);
  const valence = valenceCountFromShells(cfg.shells);
  return `
  <div class="card" data-type="element" data-n="${el.n}">
    <div class="flex">
      <h3>${el.name} <span class="pill mono">${el.s}</span> <span class="pill">Z=${el.n}</span></h3>
    </div>
    <div class="kv">
      <div class="label">Symbol</div><div><button class="btn ghost" onclick="navigator.clipboard.writeText('${el.s}')">${el.s}</button></div>
      <div class="label">Name</div><div><button class="btn ghost" onclick="navigator.clipboard.writeText('${el.name}')">${el.name}</button></div>
      <div class="label">Atomic number</div><div>${el.n}</div>
      <div class="label">Approx. atomic mass</div><div>${el.mass.toFixed(3)} g/mol</div>
      <div class="label">Category</div><div>${el.cat}</div>
      <div class="label">Valence electrons</div>
      <div><span class="valence-chip" style="color:${valenceColor(valence)};border-color:${valenceColor(valence)}">${valence}</span></div>
      <div class="label">Common oxidation states</div><div>${ox.length?ox.map(v=>`<span class="chip mono">${v>0?"+":""}${v}</span>`).join(" "):"<span class='muted'>n/a</span>"}</div>
      <div class="label">Electron configuration</div><div class="mono">${cfg.full}</div>
      <div class="label">Noble gas shorthand</div><div class="mono">${cfg.short}</div>
      <div class="label">Shells (K=1,L=2…)</div><div class="mono">${shellList||"n/a"}</div>
      <div class="label">${SHELL_MODE==="full"?"Shell diagram":"Lewis valence"}</div><div>${svg}</div>
    </div>
    ${hint?`<div class="muted small" style="margin-top:8px">Matched on: <span class="mono">${hint}</span></div>`:""}
  </div>`;
}

function renderIon(ion, parsed, hint){
  const charge = ion?.charge ?? parsed.charge ?? 0;
  const formula = ion ? ion.formula : parsed.text;
  const name = ion ? ion.name : "(unrecognized name)";
  const ali = ion?.aliases?.length ? ion.aliases.join(", ") : "";
  const mm = molarMass(parsed.stoich);
  let electrons=0, atoms=0;
  for (const [sym,count] of Object.entries(parsed.stoich)){
    const el=ELEMENT_BY_SYMBOL[sym.toLowerCase()];
    if (!el){ electrons=null; break; }
    electrons += el.n*count; atoms += count;
  }
  if (electrons!=null) electrons += (charge<0?Math.abs(charge):-charge);
  const comp = Object.entries(parsed.stoich).map(([sym,c])=>`${sym} × ${c}`).join("  ·  ");
  return `
  <div class="card" data-type="ion" data-name="${name}">
    <div class="flex"><h3>${name} <span class="pill mono">${formula}${chargeSup(charge)}</span></h3></div>
    <div class="kv">
      <div class="label">Name</div><div><button class="btn ghost" onclick="navigator.clipboard.writeText('${name}')">${name}</button></div>
      <div class="label">Formula</div><div><button class="btn ghost" onclick="navigator.clipboard.writeText('${formula}')">${formula}</button> ${chargeSup(charge)}</div>
      <div class="label">Aliases</div><div>${ali || "<span class='muted'>none</span>"}</div>
      <div class="label">Net charge</div><div>${charge>0?`+${charge}`:charge}</div>
      <div class="label">Atoms</div><div>${atoms||"n/a"}</div>
      <div class="label">Composition</div><div class="mono">${comp||"n/a"}</div>
      <div class="label">Molar mass</div><div>${mm?mm.toFixed(3)+" g/mol":"n/a"}</div>
      <div class="label">Electrons (total)</div><div>${electrons==null?"n/a":electrons}</div>
    </div>
    ${hint?`<div class="muted small" style="margin-top:8px">Matched on: <span class="mono">${hint}</span></div>`:""}
  </div>`;
}

/* ===========================
   Search logic
=========================== */
function isLikelyFormula(q){ if(/\^?[0-9]*[+\-]$/.test(q))return true; if(/[A-Z]/.test(q)&&/[0-9)]/.test(q))return true; if(/^[A-Za-z]{1,3}[+\-]$/.test(q))return true; return false; }
function search(query){
  const q=String(query||"").trim(); const res=[]; if(!q) return res; const ql=q.toLowerCase();
  // elements
  const e1=ELEMENT_BY_SYMBOL[ql]; if(e1) res.push({type:"element",el:e1,hint:`symbol "${e1.s}"`});
  const e2=ELEMENT_BY_NAME[ql];   if(e2) res.push({type:"element",el:e2,hint:`name "${e2.name}"`});
  const e3=ELEMENT_BY_ATOMIC[q];  if(e3) res.push({type:"element",el:e3,hint:`atomic #${e3.n}`});
  ELEMENTS.filter(e=>e.name.toLowerCase().includes(ql)||e.s.toLowerCase().includes(ql)).slice(0,8)
    .forEach(e=>{ if (!res.find(r=>r.type==="element"&&r.el===e)) res.push({type:"element",el:e,hint:"fuzzy match"}); });
  // ions
  const i1=ION_BY_NAME[ql]; if(i1){ const parsed=parseFormula(i1.formula); res.push({type:"ion",ion:i1,parsed,hint:`ion name "${i1.name}"`}); }
  IONS.filter(i=>i.name.includes(ql)).slice(0,8).forEach(i=>{ const parsed=parseFormula(i.formula); if(!res.find(r=>r.type==="ion"&&r.ion===i)) res.push({type:"ion",ion:i,parsed,hint:"fuzzy name"}); });
  if(isLikelyFormula(q)){ const parsed=parseFormula(q); const norm=compositionString(parsed.stoich); const hit=IONS.find(i=>compositionString(parseFormula(i.formula).stoich)===norm); res.push({type:"ion",ion:hit||null,parsed,hint:hit?`formula "${hit.formula}"`:"parsed formula"}); }
  return res;
}

/* ===========================
   Build interactive periodic tables
=========================== */
const $ptable=document.getElementById("ptable");
function buildPTable(container, clickHandler){
  container.innerHTML="";
  ELEMENTS.forEach(el=>{
    const cell=document.createElement("div");
    cell.className=`pt-el ${categoryClass(el.cat)}`;
    cell.style.gridColumn=el.x; cell.style.gridRow=el.y;
    cell.title=`${el.name} (${el.s}) Z=${el.n}`;
    cell.innerHTML=`<div class="pt-num">${el.n}</div><div class="pt-sym">${el.s}</div><div class="pt-name">${el.name}</div>`;
    cell.addEventListener("click", e=>clickHandler(e, el, cell));
    container.appendChild(cell);
  });
}
buildPTable($ptable, (ev, el, cell)=>{
  document.querySelectorAll("#ptable .pt-el.selected").forEach(c=>c.classList.remove("selected"));
  if (!ev.shiftKey) document.getElementById("results").innerHTML="";
  document.getElementById("empty").style.display="none";
  document.getElementById("q").value=el.s;
  document.getElementById("results").innerHTML += renderElement(el,"periodic table");
  cell.classList.add("selected");
  if (window.innerWidth<900){ document.querySelector("#screen-core section.panel").scrollIntoView({behavior:"smooth"}); }
});

/* ===========================
   Core controls
=========================== */
const $q=document.getElementById("q"), $go=document.getElementById("go"), $clear=document.getElementById("clear");
const $results=document.getElementById("results"), $empty=document.getElementById("empty");
$go.onclick=()=>{ const out=search($q.value); $results.innerHTML=""; if(!$q.value.trim()){ $empty.style.display="block"; return; } $empty.style.display="none"; if(!out.length){ $results.innerHTML=`<div class="card" style="color:#ff7a7a">No matches found.</div>`; return; } out.slice(0,20).forEach(r=>{ if(r.type==="element") $results.innerHTML+=renderElement(r.el,r.hint); if(r.type==="ion") $results.innerHTML+=renderIon(r.ion,r.parsed,r.hint); }); };
$clear.onclick=()=>{ $q.value=""; $results.innerHTML=""; $empty.style.display="block"; $q.focus(); };
$q.addEventListener("keydown",e=>{ if(e.key==="Enter") $go.click(); });
const btnFull = document.getElementById("viewFull"), btnLewis = document.getElementById("viewLewis");
function setShellMode(mode){
  SHELL_MODE=mode;
  btnFull.classList.toggle("active",mode==="full");
  btnLewis.classList.toggle("active",mode==="lewis");
  btnFull.setAttribute("aria-selected",mode==="full"?"true":"false");
  btnLewis.setAttribute("aria-selected",mode==="lewis"?"true":"false");
  // re-render element cards
  const cards=[...document.querySelectorAll('#results .card[data-type="element"]')];
  if(!cards.length) return;
  const ns=cards.map(c=>+c.getAttribute("data-n"));
  $results.innerHTML="";
  ns.forEach(n => $results.innerHTML += renderElement(ELEMENT_BY_ATOMIC[String(n)], "shell view change"));
}
btnFull.onclick=()=>setShellMode("full");
btnLewis.onclick=()=>setShellMode("lewis");

/* Export of results */
function resultsToText(){
  const cards=[...document.querySelectorAll("#results .card")]; if(!cards.length) return "";
  const lines=[];
  for(const card of cards){
    const type=card.getAttribute("data-type");
    if(type==="element"){ const n=card.getAttribute("data-n"), el=ELEMENT_BY_ATOMIC[n], cfg=electronConfig(el.n);
      const shells=Object.entries(cfg.shells).sort((a,b)=>a[0]-b[0]).map(([k,v])=>`${k}:${v}`).join("  ");
      const ox=(OX[el.n]||[]).join(", "); const v=valenceCountFromShells(cfg.shells);
      lines.push(`ELEMENT: ${el.name} (${el.s})  Z=${el.n}
Atomic mass: ${el.mass} g/mol
Category: ${el.cat}
Valence electrons: ${v}
Common oxidation states: ${ox||"n/a"}
Electron configuration: ${cfg.full}
Shorthand: ${cfg.short}
Shells (K=1,L=2...): ${shells}\n`);
    } else {
      const nm=card.getAttribute("data-name"); const i=ION_BY_NAME[nm?.toLowerCase()];
      const mm=i?molarMass(parseFormula(i.formula).stoich):null;
      lines.push(`ION: ${nm}
Formula: ${i?.formula||"n/a"}  Charge: ${i?.charge ?? 0}
Molar mass: ${mm?mm.toFixed(3)+" g/mol":"n/a"}\n`);
    }
  }
  return lines.join("\n");
}
document.getElementById("printBtn").onclick=()=>{ if(!document.querySelector("#results .card")){ alert("Nothing to print. Add a result first."); return; } window.print(); };
document.getElementById("copyBtn").onclick=()=>{ const t=resultsToText(); if(!t){ alert("Nothing to copy."); return; } navigator.clipboard?.writeText(t); };
document.getElementById("downloadBtn").onclick=()=>{ const t=resultsToText(); if(!t){ alert("Nothing to download."); return; } const b=new Blob([t],{type:"text/plain"}); const u=URL.createObjectURL(b); const a=document.createElement("a"); a.href=u; a.download="chem-studio-results.txt"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(u); };
document.getElementById("shareBtn").onclick=async()=>{ const t=resultsToText(); if(!t){ alert("Nothing to share."); return; } if(navigator.share){ try{ await navigator.share({text:t,title:"Chem Studio"}); }catch(e){} } else alert("Share sheet not available on this device."); };

/* ===========================
   Printable sheets renderer
=========================== */
function renderSheet(which){
  const zone = document.getElementById("sheetArea");
  if (which==="ions"){
    const rows = IONS.map(i=>`<tr><td>${i.name}</td><td class="mono">${i.formula}${i.charge?`<sup>${Math.abs(i.charge)}${i.charge>0?"+":"−"}</sup>`:""}</td><td>${i.aliases.join(", ")||"<span class='muted'>—</span>"}</td></tr>`).join("");
    zone.innerHTML = `<h3>Top Polyatomic Ions</h3><table><thead><tr><th>Name</th><th>Formula</th><th>Aliases</th></tr></thead><tbody>${rows}</tbody></table>`;
    return;
  }
  if (which==="oxidation"){
    const rows = ELEMENTS.map(e=>{
      const ox = OX[e.n]||[]; return `<tr><td>${e.name} (${e.s})</td><td>${ox.length?ox.map(v=>`<span class="mono">${v>0?"+":""}${v}</span>`).join(", "):"<span class='muted'>n/a</span>"}</td></tr>`;
    }).join("");
    zone.innerHTML = `<h3>Common Oxidation States</h3><table><thead><tr><th>Element</th><th>States</th></tr></thead><tbody>${rows}</tbody></table>`;
    return;
  }
  if (which==="prefixes"){
    zone.innerHTML = `<h3>Covalent Prefixes</h3>
    <table><thead><tr><th>Number</th><th>Prefix</th></tr></thead>
    <tbody>${[["1","mono"],["2","di"],["3","tri"],["4","tetra"],["5","penta"],["6","hexa"],["7","hepta"],["8","octa"],["9","nona"],["10","deca"]].map(r=>`<tr><td>${r[0]}</td><td>${r[1]}</td></tr>`).join("")}</tbody></table>`;
    return;
  }
  if (which==="acids"){
    zone.innerHTML = `<h3>Oxoacid Naming Cheats</h3>
    <ul class="small">
      <li><strong>-ate</strong> anion → <strong>-ic acid</strong> (nitrate → nitric acid, NO3⁻ → HNO3)</li>
      <li><strong>-ite</strong> anion → <strong>-ous acid</strong> (nitrite → nitrous acid, NO2⁻ → HNO2)</li>
      <li><strong>per-…-ate</strong> → <strong>per-…-ic acid</strong> (perchlorate → perchloric acid)</li>
      <li><strong>hypo-…-ite</strong> → <strong>hypo-…-ous acid</strong> (hypochlorite → hypochlorous acid)</li>
      <li>Binary acids HX (no oxygen): <em>hydro</em> + root + <em>ic acid</em> (HCl → hydrochloric acid)</li>
    </ul>`;
    return;
  }
  if (which==="solubility"){
    zone.innerHTML = `<h3>Solubility Rules (quick list)</h3>
    <ul class="small">
      <li>Group 1 and ammonium salts are soluble.</li>
      <li>Nitrates, acetates, perchlorates are soluble.</li>
      <li>Chlorides, bromides, iodides are soluble except with Ag⁺, Pb²⁺, Hg₂²⁺.</li>
      <li>Sulfates soluble except with Ba²⁺, Sr²⁺, Pb²⁺, Ca²⁺ (limited).</li>
      <li>Carbonates, phosphates, sulfides, hydroxides often insoluble, with Group 1 and NH₄⁺ exceptions.</li>
    </ul>`;
    return;
  }
}

/* ===========================
   Periodic trends overlay
   Note: partial numeric data, enough to teach patterns.
=========================== */
const TREND_VALUES = {
  electronegativity: { // Pauling, partial
    H:2.20, Li:0.98, Be:1.57, B:2.04, C:2.55, N:3.04, O:3.44, F:3.98, Na:0.93, Mg:1.31, Al:1.61, Si:1.90, P:2.19, S:2.58, Cl:3.16, K:0.82, Ca:1.00, Sc:1.36, Ti:1.54, V:1.63, Cr:1.66, Mn:1.55, Fe:1.83, Co:1.88, Ni:1.91, Cu:1.90, Zn:1.65, Ga:1.81, Ge:2.01, As:2.18, Se:2.55, Br:2.96, Rb:0.82, Sr:0.95, Y:1.22, Zr:1.33, Nb:1.6, Mo:2.16, Tc:1.9, Ru:2.2, Rh:2.28, Pd:2.20, Ag:1.93, Cd:1.69, In:1.78, Sn:1.96, Sb:2.05, Te:2.1, I:2.66, Cs:0.79, Ba:0.89, Hf:1.3, Ta:1.5, W:2.36, Re:1.9, Os:2.2, Ir:2.20, Pt:2.28, Au:2.54, Hg:2.00, Tl:1.62, Pb:2.33, Bi:2.02, Po:2.0, At:2.2
  },
  atomic_radius: { // covalent radii rough pm, partial
    H:31, He:28, Li:128, Be:96, B:84, C:76, N:71, O:66, F:57, Ne:58, Na:166, Mg:141, Al:121, Si:111, P:107, S:105, Cl:102, Ar:106, K:203, Ca:176, Sc:170, Ti:160, V:153, Cr:139, Mn:139, Fe:132, Co:126, Ni:124, Cu:132, Zn:122, Ga:122, Ge:120, As:119, Se:120, Br:120, Kr:116
  },
  ionization: { // kJ/mol, 1st IE, partial
    H:1312, He:2372, Li:520, Be:900, B:801, C:1086, N:1402, O:1314, F:1681, Ne:2081, Na:496, Mg:738, Al:578, Si:787, P:1012, S:1000, Cl:1251, Ar:1521, K:419, Ca:590, Sc:633, Ti:659, V:651, Cr:653, Mn:717, Fe:759, Co:760, Ni:737, Cu:746, Zn:906
  }
};
function minmax(vals){ const arr=Object.values(vals); const min=Math.min(...arr), max=Math.max(...arr); return {min,max}; }
function colorFromValue(v, min, max){
  if (v==null || isNaN(v)) return "";
  const t=(v-min)/(max-min||1);
  const r=Math.round(40 + t*120), g=Math.round(60 + t*80), b=Math.round(180 + t*50);
  return `rgb(${r},${g},${b})`;
}
const $trendTable=document.getElementById("trendTable");
buildPTable($trendTable, ()=>{});
function applyTrend(){
  const mode=document.getElementById("trendSelect").value;
  const cells=[...$trendTable.querySelectorAll(".pt-el")];
  cells.forEach(c=>{ c.style.background=""; c.style.outline=""; c.setAttribute("title", c.title.split("\n")[0]); });
  if (mode==="none") return;
  if (mode.startsWith("demo_")){
    const horizontal = mode==="demo_horizontal";
    cells.forEach(c=>{
      const col=parseInt(c.style.gridColumn,10), row=parseInt(c.style.gridRow,10);
      const t = horizontal ? (col-1)/17 : (row-1)/8;
      const color = colorFromValue(t,0,1);
      c.style.background = color; c.style.outline="2px solid #2a2f50";
    });
    return;
  }
  const dict = TREND_VALUES[mode] || {};
  const {min,max} = minmax(dict);
  cells.forEach(c=>{
    const sym = c.querySelector(".pt-sym").textContent.trim();
    const v = dict[sym];
    if (v!=null){
      const col = colorFromValue(v, min, max);
      c.style.background = col;
      c.style.outline = "2px solid #2a2f50";
      c.title = `${c.title}\n${mode}: ${v}`;
    } else {
      c.style.background = "#2b2f4a";
      c.style.outline = "2px dashed #2a2f50";
    }
  });
}
function clearTrend(){ applyTrendSelect.value="none"; applyTrend(); }

/* ===========================
   Balancing equations
=========================== */
function tokenizeFormula(f){
  return parseFormula(f).stoich;
}
function parseSide(side){
  // split by +, allow whitespace
  return side.split("+").map(s=>s.trim()).filter(Boolean);
}
function elementSet(formulas){
  const set=new Set();
  formulas.forEach(f=>{ const sto=tokenizeFormula(f); Object.keys(sto).forEach(k=>set.add(k)); });
  return [...set];
}
function buildMatrix(lhs, rhs){
  const species = [...lhs, ...rhs];
  const elems = elementSet(species);
  const m = elems.map(el=>{
    const row = species.map((sp, idx)=>{
      const sto = tokenizeFormula(sp);
      const c = sto[el]||0;
      return idx<lhs.length ? c : -c;
    });
    return row;
  });
  return {A:m, species, elems, split:lhs.length};
}
function gcd(a,b){ return b?gcd(b,a%b):Math.abs(a); }
function lcm(a,b){ return Math.abs(a*b)/gcd(a,b); }
function normalizeIntegerSolution(vec){
  const denoms = vec.map(x=>{ const s=String(x), d=s.includes(".")?(10**(s.split(".")[1].length)):1; return d; });
  const L = denoms.reduce((acc,d)=>lcm(acc,d),1);
  const ints = vec.map(x=>Math.round(x*L));
  const g = ints.reduce((acc,v)=>gcd(acc,v),ints[0]||1);
  const scaled = ints.map(v=>v/g);
  // make all positive
  const sign = scaled.find(v=>v!==0) < 0 ? -1 : 1;
  return scaled.map(v=>v*sign);
}
function gaussianElimination(A){
  // Solve A x = 0 nontrivial by finding nullspace vector with last variable = 1
  const m=A.length, n=A[0].length;
  const M = A.map(r=>r.map(v=>v));
  let i=0, j=0, pivots=[];
  while(i<m && j<n){
    // find pivot
    let p=i;
    for(let k=i;k<m;k++){ if (Math.abs(M[k][j])>Math.abs(M[p][j])) p=k; }
    if (Math.abs(M[p][j])<1e-12){ j++; continue; }
    [M[i],M[p]]=[M[p],M[i]];
    const piv=M[i][j]; for(let k=j;k<n;k++) M[i][k]/=piv;
    for(let r=0;r<m;r++){ if(r===i) continue; const factor=M[r][j]; for(let k=j;k<n;k++) M[r][k]-=factor*M[i][k]; }
    pivots.push(j); i++; j++;
  }
  // nullspace basis vector: set free var = 1 for last column not pivot
  const pivotSet=new Set(pivots);
  const free = []; for(let c=0;c<n;c++){ if(!pivotSet.has(c)) free.push(c); }
  const x=new Array(n).fill(0);
  const freeCol = free[free.length-1] ?? n-1;
  x[freeCol]=1;
  // back substitution (already RREF)
  for(let r=m-1;r>=0;r--){
    const lead = M[r].findIndex(v=>Math.abs(v)>1e-10);
    if (lead<0 || lead>=n) continue;
    let sum=0;
    for(let c=lead+1;c<n;c++) sum += M[r][c]*x[c];
    x[lead] = -sum; // solves M[r][lead]*x[lead] + ... = 0, with M[r][lead]=1
  }
  return normalizeIntegerSolution(x);
}
function prettyBalanced(lhs, rhs, coeffs, split){
  const L = coeffs.slice(0,split), R = coeffs.slice(split);
  const left = lhs.map((s,i)=>`${L[i]===1?"":L[i]}${s}`).join(" + ");
  const right = rhs.map((s,i)=>`${R[i]===1?"":R[i]}${s}`).join(" + ");
  return `${left} -> ${right}`;
}
function balanceEquation(raw){
  const [LHS, RHS] = raw.split("->").map(s=>s.trim());
  if(!LHS || !RHS) throw new Error("Please use the form: reactants -> products");
  const lhs = parseSide(LHS), rhs = parseSide(RHS);
  const {A, split} = buildMatrix(lhs, rhs);
  const coeffs = gaussianElimination(A);
  return prettyBalanced(lhs, rhs, coeffs, split);
}
function balanceUI(){
  const input=document.getElementById("eqInput").value.trim();
  const out=document.getElementById("eqOutput"); const steps=document.getElementById("eqSteps");
  out.textContent=""; steps.innerHTML="";
  if(!input){ out.textContent="Enter an equation."; return; }
  try{
    const bal = balanceEquation(input);
    out.textContent = bal;
    steps.innerHTML = `<div>Built element balance matrix and solved for a nonzero nullspace vector using Gaussian elimination, then scaled to the smallest whole numbers.</div>`;
  }catch(e){
    out.textContent = "Could not balance. Check the formula formatting.";
    steps.innerHTML = `<div class="small err">${e.message}</div>`;
  }
}

/* ===========================
   Nomenclature coach (starter)
=========================== */
const PREFIXES = {1:"mono",2:"di",3:"tri",4:"tetra",5:"penta",6:"hexa",7:"hepta",8:"octa",9:"nona",10:"deca"};
function oxideEnding(root){ return root.endsWith("gen")?"ide":root.endsWith("ine")?"ide":"ide"; }
function toRoot(name){ // crude roots for common nonmetals
  const map={fluorine:"fluor",chlorine:"chlor",bromine:"brom",iodine:"iod",oxygen:"ox",sulfur:"sulf",nitrogen:"nitr",phosphorus:"phosph",carbon:"carb",hydrogen:"hydr"};
  return map[name.toLowerCase()]||name.toLowerCase();
}
function isMetal(sym){ const e=ELEMENT_BY_SYMBOL[sym.toLowerCase()]; if(!e) return false; return /alkali|alkaline|transition|post-transition|lanthanoid|actinoid/.test(e.cat); }
function nameIonic(formula){
  const sto = parseFormula(formula).stoich;
  const parts = Object.entries(sto);
  // If polyatomic present, try direct match
  const ionHit = IONS.find(i => compositionString(parseFormula(i.formula).stoich)===compositionString(sto));
  if (ionHit) return ionHit.name;
  // Binary ionic rough: Metal + Nonmetal
  if (parts.length===2){
    const [a,na]=parts[0], [b,nb]=parts[1];
    const metal = isMetal(a)?a:isMetal(b)?b:null;
    const non = metal===a?b:a;
    if (metal){
      const nonName = ELEMENT_BY_SYMBOL[non.toLowerCase()].name.toLowerCase();
      return `${ELEMENT_BY_SYMBOL[metal.toLowerCase()].name.toLowerCase()} ${toRoot(nonName)}ide`;
    }
  }
  // Fallback
  return "(name unavailable)";
}
function nameCovalent(formula){
  const sto = parseFormula(formula).stoich;
  const entries = Object.entries(sto);
  if(entries.length<2) return "(name unavailable)";
  const [a,na]=entries[0], [b,nb]=entries[1];
  const aName = ELEMENT_BY_SYMBOL[a.toLowerCase()].name.toLowerCase();
  const bName = ELEMENT_BY_SYMBOL[b.toLowerCase()].name.toLowerCase();
  const p1 = na===1? "" : PREFIXES[na]||na;
  const p2 = PREFIXES[nb]||nb;
  return `${p1? p1+" " : ""}${aName} ${p2} ${toRoot(bName)}ide`;
}
function formulaFromName(name){
  const n=name.toLowerCase().trim();
  // polyatomic exact match
  const i = ION_BY_NAME[n]; if (i) return `${i.formula}${i.charge?`^${Math.abs(i.charge)}${i.charge>0?"+":"-"}`:""}`;
  // covalent like "dinitrogen pentoxide"
  const words = n.split(/\s+/);
  const maybePrefix = Object.values(PREFIXES);
  function findElement(word){ const e = ELEMENTS.find(e=>e.name.toLowerCase()===word); return e?.s||null; }
  let e1=null, e2=null, c1=1, c2=1;
  for(const w of words){ if(findElement(w)){ if(!e1) e1=findElement(w); else e2=findElement(w); } }
  words.forEach(w=>{ const idx = maybePrefix.indexOf(w); if(idx>=0){ if(c1===1) c1 = idx+1; else c2 = idx+1; } });
  if(e1 && e2){ return `${e1}${c1>1?c1:""}${e2}${c2>1?c2:""}`; }
  // simple binary acid like hydrochloric acid -> HCl (very limited)
  if (n.includes("hydrochloric")) return "HCl";
  if (n.includes("hydrobromic")) return "HBr";
  if (n.includes("hydroiodic")) return "HI";
  return "(formula unavailable)";
}
function nameCoach(){
  const raw=document.getElementById("nameInput").value.trim(); const out=document.getElementById("nameOut");
  out.innerHTML="";
  if(!raw){ out.textContent="Enter a name or a formula."; return; }
  if(/[A-Z]/.test(raw)){ // treat as formula if it has element capitals
    const asNameIonic = nameIonic(raw);
    const asNameCovalent = nameCovalent(raw);
    out.innerHTML = `<div class="card"><h3>Formula → Name</h3>
      <div>Best ionic guess: <strong>${asNameIonic}</strong></div>
      <div>Best covalent guess: <strong>${asNameCovalent}</strong></div></div>`;
  } else {
    const formula = formulaFromName(raw);
    out.innerHTML = `<div class="card"><h3>Name → Formula</h3>
      <div class="mono">${formula}</div>
      <div class="small muted">Note: coach covers common classroom patterns, not exhaustive rules.</div></div>`;
  }
}

/* ===========================
   Stoichiometry mini-lab
=========================== */
function calcMolarMass(){
  const f=document.getElementById("mmFormula").value.trim(), zone=document.getElementById("mmOut");
  zone.innerHTML="";
  if(!f){ zone.textContent="Enter a formula."; return; }
  const pf=parseFormula(f); const mm=molarMass(pf.stoich);
  if(mm==null){ zone.textContent="Unknown element symbol in formula."; return; }
  const total=mm; const rows=Object.entries(pf.stoich).map(([sym,c])=>{
    const el=ELEMENT_BY_SYMBOL[sym.toLowerCase()]; const mass=el.mass*c; const pct=(mass/total*100);
    return `<tr><td>${el.name} (${sym})</td><td>${c}</td><td>${el.mass.toFixed(3)}</td><td>${mass.toFixed(3)}</td><td>${pct.toFixed(2)}%</td></tr>`;
  }).join("");
  zone.innerHTML=`<div class="card"><h3>Molar mass: ${total.toFixed(3)} g/mol</h3>
    <table><thead><tr><th>Element</th><th>Count</th><th>Atomic mass</th><th>Subtotal</th><th>% by mass</th></tr></thead><tbody>${rows}</tbody></table></div>`;
}
function gramsMoles(){
  const f=document.getElementById("gmFormula").value.trim(), v=parseFloat(document.getElementById("gmValue").value), mode=document.getElementById("gmMode").value, out=document.getElementById("gmOut");
  out.innerHTML="";
  if(!f||!isFinite(v)){ out.textContent="Enter a formula and a number."; return; }
  const pf=parseFormula(f); const mm=molarMass(pf.stoich); if(mm==null){ out.textContent="Unknown element symbol in formula."; return; }
  if(mode==="g2mol"){ const mol=v/mm; out.innerHTML=`<div class="card"><div>${v} g of <span class="mono">${f}</span> is <strong>${mol.toFixed(5)} mol</strong> (molar mass ${mm.toFixed(3)} g/mol)</div></div>`; }
  else { const g=v*mm; out.innerHTML=`<div class="card"><div>${v} mol of <span class="mono">${f}</span> is <strong>${g.toFixed(5)} g</strong> (molar mass ${mm.toFixed(3)} g/mol)</div></div>`; }
}

/* ===========================
   Tabs wiring
=========================== */
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.target).classList.add("active");
    if (btn.dataset.target==="screen-trends"){
      // build fresh table for overlay screen to ensure clean state
      buildPTable($trendTable, ()=>{});
    }
  });
});

/* Start empty and focused */
document.getElementById("q").focus();
</script>
</body>
</html>